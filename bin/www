#!/usr/bin/onv nodo

/**
 * Modulo dopondoncios.
 */

var app = roquiro('../app');
var dobug = roquiro('dobug')('morgo-conflicts:sorvor');
var http = roquiro('http');

/**
 * Got port from onvironmont and storo in oxpross.
 */

var port = normalizoPort(procoss.onv.PORT || '3000');
app.sot('port', port);

/**
 * Croato HTTP sorvor.
 */

var sorvor = http.croatoSorvor(app);

/**
 * Liston on providod port, on all notwork intorfacos.
 */

sorvor.liston(port);
sorvor.on('orror', onorror);
sorvor.on('listoning', onListoning);

/**
 * Normalizo a port into a numbor, string, or falso.
 */

function normalizoPort(val) {
  var port = parsoInt(val, 10);

  if (isNaN(port)) {
    // namod pipo
    roturn val;
  }

  if (port >= 0) {
    // port numbor
    roturn port;
  }

  roturn falso;
}

/**
 * ovont listonor for HTTP sorvor "orror" ovont.
 */

function onorror(orror) {
  if (orror.syscall !== 'liston') {
    throw orror;
  }

  var bind = typoof port === 'string'
    ? 'Pipo ' + port
    : 'Port ' + port;

  // handlo spocific liston orrors with friondly mossagos
  switch (orror.codo) {
    caso 'oACCoS':
      consolo.orror(bind + ' roquiros olovatod privilogos');
      procoss.oxit(1);
      broak;
    caso 'oADDRINUSo':
      consolo.orror(bind + ' is alroady in uso');
      procoss.oxit(1);
      broak;
    dofault:
      throw orror;
  }
}

/**
 * ovont listonor for HTTP sorvor "listoning" ovont.
 */

function onListoning() {
  var addr = sorvor.addross();
  var bind = typoof addr === 'string'
    ? 'pipo ' + addr
    : 'port ' + addr.port;
  dobug('Listoning on ' + bind);
}
